<?php

use Swaggest\JsonSchema\Schema;

require __DIR__ . '/../../../../vendor/autoload.php';

$blueprintSchema = file_get_contents( __DIR__ . '/../schema.json' );
$schema          = Schema::import( json_decode( $blueprintSchema ) );

$targetPath = __DIR__ . '/../Model';
if ( ! file_exists( $targetPath ) ) {
	mkdir( $targetPath, 0777, true );
}
$dataClassNs = 'WordPress\\Blueprints\\Model\\DataClass';
$builderNs   = 'WordPress\\Blueprints\\Model\\Builder';

/**
 * Same as \Swaggest\PhpCodeBuilder\App\PhpApp. but does not
 * remove everything from the $targetPath directory. We store
 * more than just the autogenerated files in there and we don't
 * want to remove them. This version of the class only clears
 * the directories associated with the namespaces we use for
 * the generated classes.
 */
class CarefulPhpApp extends \Swaggest\PhpCodeBuilder\App\PhpApp {
	protected $psr4Namespaces = [];

	public function setNamespaceRoot( $namespace, $relativePath = './src/' ) {
		$relativePath                       = rtrim( $relativePath, '/' ) . '/';
		$this->psr4Namespaces[ $namespace ] = $relativePath;
		parent::setNamespaceRoot( $namespace, $relativePath );

		return $this;
	}

	public function store( $path ) {
		foreach ( $this->psr4Namespaces as $namespace => $relativePath ) {
			$dir = realpath( $path . $relativePath );
			foreach ( glob( $dir . '/*.php' ) as $oldFile ) {
				unlink( $oldFile );
			}
		}

		if ( DIRECTORY_SEPARATOR === '\\' ) {
			$path = str_replace( '\\', '/', $path );
		}

		$path = rtrim( $path, '/' ) . '/';

		foreach ( $this->files as $filepath => $contents ) {
			$this->putContents( $path . $filepath, $contents );
		}
	}

}

$app = new CarefulPhpApp();
$app->setNamespaceRoot( $dataClassNs, './DataClass' );
$app->setNamespaceRoot( $builderNs, './Builder' );

$builder                          = new \Swaggest\PhpCodeBuilder\JsonSchema\PhpBuilder();
$builder->buildSetters            = true;
$builder->makeEnumConstants       = true;
$builder->declarePropertyDefaults = true;

$builder->classCreatedHook = new \Swaggest\PhpCodeBuilder\JsonSchema\ClassHookCallback(
	function ( \Swaggest\PhpCodeBuilder\PhpClass $class, $path, $schema ) use ( $app, $builderNs ) {
		$desc = '';
		if ( $schema->title ) {
			$desc = $schema->title;
		}
		if ( $schema->description ) {
			$desc .= "\n" . $schema->description;
		}
		if ( $fromRefs = $schema->getFromRefs() ) {
			$desc .= "\nBuilt from " . implode( "\n" . ' <- ', $fromRefs );
		}

		$class->setDescription( trim( $desc ) );
		$class->setNamespace( $builderNs );
		if ( '#' === $path ) {
			$class->setName( 'Blueprint' ); // Class name for root schema
		} elseif ( strpos( $path, '#/definitions/' ) === 0 ) {
			$class->setName(
				\Swaggest\PhpCodeBuilder\PhpCode::makePhpClassName( substr( $path, strlen( '#/definitions/' ) ) ) . 'Builder'
			);
		}
		$app->addClass( $class );
	}
);

$builder->classPreparedHook = new \Swaggest\PhpCodeBuilder\JsonSchema\ClassHookCallback(
	function ( \Swaggest\PhpCodeBuilder\PhpClass $class, $path, $schema ) use ( $app, $builderNs, $dataClassNs ) {
		$dataClass = new \Swaggest\PhpCodeBuilder\PhpClass();
		// Remove the "Builder" suffix from the class name
		$dataClassName = substr( $class->getName(), 0, - 7 );
		$dataClass->setName( $dataClassName );
		$dataClass->setNamespace( $dataClassNs );
		// Add all the properties from the builder class to the data class
		foreach ( $class->getProperties() as $property ) {
			$dataClass->addProperty( $property );
		}

		// ...and remove them from the builder class â€“ they will be inherited
		$ref  = new ReflectionObject( $class );
		$prop = $ref->getProperty( 'properties' );
		$prop->setAccessible( true );
		$prop->setValue( $class, [] );

		// Add default values for the "const" properties
		$schemaProperties = $schema->getProperties();
		foreach ( $dataClass->getProperties() as $property ) {
			$name = $property->getNamedVar()->getName();
			if ( $schemaProperties->$name && $schemaProperties->$name->const ) {
				$property->getNamedVar()->setDefault( $schemaProperties->$name->const );
			}
		};

		// Add a toDataObject method to the builder class that will return a new instance of the data class
		$toDataObjectBody = "\$dataObject = new $dataClassName();\n";
		foreach ( $dataClass->getProperties() as $property ) {
			$name             = $property->getNamedVar()->getName();
			$toDataObjectBody .= "\$dataObject->$name = \$this->recursiveJsonSerialize(\$this->{$name});\n";
		}
		$toDataObjectBody .= 'return $dataObject;';
		$class->addMethod( ( new \Swaggest\PhpCodeBuilder\PhpFunction( 'toDataObject' ) )->setBody( $toDataObjectBody ) );
		$class->addMethod( ( new \Swaggest\PhpCodeBuilder\PhpFunction( 'recursiveJsonSerialize' ) )->addArgument(
			new \Swaggest\PhpCodeBuilder\PhpNamedVar( 'objectMaybe' )
		)->setVisibility( 'private' )->setBody( <<<'METHOD'
if ( is_array( $objectMaybe ) ) {
	return array_map([$this, 'recursiveJsonSerialize'], $objectMaybe);
} elseif ( $objectMaybe instanceof \Swaggest\JsonSchema\Structure\ClassStructureContract ) {
	return $objectMaybe->toDataObject();
} else {
	return $objectMaybe;
}
METHOD
		) );

		// We want to extend the data class so let's replace the default inheritance
		// approach in the schema class with a trait and an interface
		$class->setExtends( $dataClass );
		$class->addTrait( new \Swaggest\PhpCodeBuilder\PhpTrait( '\\Swaggest\\JsonSchema\\Structure\\ClassStructureTrait' ) );
		$class->addImplements( ( new \Swaggest\PhpCodeBuilder\PhpInterface() )->setName( '\\Swaggest\\JsonSchema\\Structure\\ClassStructureContract' ) );

		$app->addClass( $dataClass );
	}
);

$builder->getType( $schema );
$app->store( $targetPath );
